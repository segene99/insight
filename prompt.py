import openai

# keys.txt 파일에서 API 키들을 읽어오는 함수
def read_keys_from_file(filename):
    with open(filename, 'r') as f:
        lines = f.readlines()
        openai_key = lines[0].strip().split('=')[1].replace('"', '')
    return openai_key

# keys.txt path
keys_txt_path = 'key/keys.txt'

# keys.txt 파일에서 API 키들을 가져옴
openai_key_value = read_keys_from_file(keys_txt_path)

# 가져온 키를 변수에 대입
openai.api_key = openai_key_value
# 모델과 관련된 상수 설정
MAX_TOKENS = 16000  # gpt-3.5-turbo 모델의 최대 토큰 수
OVERLAP_TOKENS = 50  # 문장이 훼손되지 않게 하기 위한 오버랩 토큰 수

def split_text(text, max_length, overlap):
    tokens = text.split()
    chunks = []

    current_chunk = []
    current_length = 0
    for token in tokens:
        current_chunk.append(token)
        current_length += len(token)
        if current_length + overlap >= max_length:
            chunks.append(' '.join(current_chunk))
            current_chunk = current_chunk[-overlap:]
            current_length = sum(len(t) for t in current_chunk)
    
    if current_chunk:
        chunks.append(' '.join(current_chunk))
    
    return chunks

def ask_gpt(question, ocr_text):
    text_chunks = split_text(ocr_text, MAX_TOKENS - 300, OVERLAP_TOKENS)
    responses = []

    for chunk in text_chunks:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo-16k",
            temperature=0.1,  # 온도값 설정
            messages=[
                {"role": "system", "content": f"당신은 친절한 쇼핑 도우미입니다. 주어진 OCR 텍스트 안의 정보만을 기반으로 질문에 답하십시오.\n\n{chunk}"},
                {"role": "user", "content": question}
            ]
        )
        
        response_text = response.choices[0].message['content'].strip()
        responses.append(response_text)

    combined_response = ' '.join(responses)

    # 사용자의 질문에 있는 키워드가 OCR 텍스트에 없고, GPT의 응답에 그 키워드가 포함되어 있는지 확인
    question_keywords = question.split()
    for keyword in question_keywords:
        if keyword not in ocr_text and keyword in combined_response:
            return "원하는 정보를 찾을 수 없습니다."

    return combined_response

# 사용자로부터 질문 받기
user_input = input("무엇을 도와드릴까요? ")
#ocr에서 받은 텍스트라 가정
ocr_data = """ 
연출된 이미지 입니다.탱글탱글한 새우를 넣어 담백한새우볶음밥N 270gpoint탱글탱글한 새우를넣어 담백한 볶음밥후라이팬 조리시point중불4~5분찰지고 고슬고슬한 밥알조리법중불에 기름을 두르고 냉동상태의볶음밥을 넣고 중불에서약4~5분 조리???식품안전관리인증HACCP식품의약품안전처point집에서도 간편하고맛있는 볶음밥을
1
 
제품명식품유형제조 및 판매원해동방법내용량원재료명보관방법반품및교환유통기한건일냉동전자레인지 조리시270g(450kcal) 냉동보관냉동상태의 볶음밥을 전자레인지용용기에 담고 랩을 씌운 후 조리700W  약 4분1000W  약 3분상품정보새우볶음밥N새우 4.82%새우볶음밥N즉석조리식품(가열하여 섭취하는 냉동식품)천일식품(주) / 인천광역시 남동구 앵고개로 426냉동상태로 조리270g쌀(외국산), 정제수, 전란액(국산), 양파(중국산), 새우(베트남산), 양배추, 대파, 당근, 대두유, 홍피망, 부추, 소스],소스2, 소스3, 소스4, 물엿, 설탕, 향미유, 혼합제제(해바라기오일, 양파오일, 천천스모크향, 참깨오일,계피유, 아세틸프로피오닐, 아세토인), 정제소금, 소스5,복합조미식품1, 복합조미식품2, 천연향신료(후추 100%)알류(계란), 우유, 대두, 밀, 게, 새우, 돼지고기, 닭고기,쇠고기, 오징어, 조개류(굴, 홍합) 함유-18℃이하 냉동보관구입처 및 판매원별도 표기일까지-이미 냉동된바 있으니 해동 후 재냉동시키지 마시기 바랍니다.뜨거운 불로 조리시 데이지 않도록 주의하십시오.-기름으로 조리시 기*름이 튀지 않도록 주의하십시오.-조리 후 제품이나 용기가 뜨거우니 주의하십시오.이 제품은 알류, 메밀, 땅콩, 고등어, 복숭아, 토마토, 아황산류 호두, 잣을 사용한제품과 같은 제조시설에서 제조하고 있습니다.
2
 
상품이 녹아서 왔어요.어떻게 해야하나요?Q&A상품이 녹아서 왔어요.날씨의 영향으로 녹아서 배송되는 경우가 많습니다.고객님께 출고전까지 냉동보관 후 기본 아이스팩 동봉하여발송하고있으나 날씨나 배송상태에 따라 녹을 수 있는점양해부탁드립니다. 상품의 신선도를 위해 아이스팩을추가적으로 구매하시는것을 적극 추천드립니다.아이스팩을 추가로 구매하고 싶어요.상품 선택후 추가구성(보냉박스)을 선택해주세요.(보냉박스 추가주문시 아이스팩 x 3팩이 추가로 포장됩니다.)추가구성 상품을 선택하세요.보냉박스 (+1,000원)보냉박스 (+1,000원)추가구성ERICE성아이스팩(납작이) x 3팩상품 주문시 기본 아이스팩은 들어가지만 하절기에는 추가 구매를 권장해드립니다.
3
 
주문전 확인사항고객센터상품에 대한 문의나 불량, 파손 문의는 고객센터 또는 게시판 이용 부탁드립니다.이용안내고객센터  010-4167-5008평 일  10시 ~ 17시점심시간  12시 ~ 13시업무로 인해 통화가 어려울 시 게시판 이용부탁드립니다.배송안내지정일 발송불가주문결제 후 3일이내 발송단, 주문량이 많거나 재고부족시 다소 기간이 소요될 수 있습니다.ㄴ 안심번호 사용은 피해주시길 바랍니다.번호가 계속바뀌어 배송에 차질이 발생합니다.▣ 제품 반품시 CJ택배사 이용바랍니다.(CJ대한통운 택배사 이용하고 있습니다.)타택배사 이용시 추가금이 발생합니다. (구매자 부담)묶음배송 가능여부 게시판 이용바랍니다.2판매자랑 협의 없는 교환·반품은 수취 거절됩니다.교환·반품판매자와 합의없이 교환 반품시 반품 불가로 상품은 다시 돌아갑니다.▣ 미배송 오배송 파손시받으신 택배박스와 운송장 사진이 필요합니다.박스와 제품을 버리신 경우 교환 환불 불가합니다.단순변심, 주문오류, 상품훼손(주소지 불분명,연락불통, 맛이없다 크기가 작다, 모양이 다르다, 행사가 취소됐다. 등)식품의 경우 재판매가 불가하여 파손, 불량에 한해 교환 환불 가능합니다.1+1상품이라도 파손된 상품만 교환 환불 가능합니다.진공포장된 상품들은 택배 배송중 진공이 풀릴수 있습니다.위 사유로 교환 반품 불가합니다. (진공풀린제품은 발송안합니다.)제품이 녹아서 도착하는 경우날씨나 수령 시간에 따라 상품이녹아서 도착할 수있습니다.녹는건 제품 하자가 아니며 녹았다는이유로 교환 환불 불가합니다.추가적인 문의를 원하시는 경우 고객센터 연락바랍니다.물품누락시상품 누락, 오배송시 연락 주시면 CCTV 확인 후 처리해드리겠습니다.택배 수령 즉시 하자여부를 확인하시고 냉동보관 바랍니다.
4
 
연출된 이미지 입니다.탱글탱글한 새우를 넣어 담백한새우볶음밥N 270gpoint탱글탱글한 새우를넣어 담백한 볶음밥후라이팬 조리시point중불4~5분찰지고 고슬고슬한 밥알조리법중불에 기름을 두르고 냉동상태의볶음밥을 넣고 중불에서약4~5분 조리???식품안전관리인증HACCP식품의약품안전처point집에서도 간편하고맛있는 볶음밥을
5
 
제품명식품유형제조 및 판매원해동방법내용량원재료명보관방법반품및교환유통기한건일냉동전자레인지 조리시270g(450kcal) 냉동보관냉동상태의 볶음밥을 전자레인지용용기에 담고 랩을 씌운 후 조리700W  약 4분1000W  약 3분상품정보새우볶음밥N새우 4.82%새우볶음밥N즉석조리식품(가열하여 섭취하는 냉동식품)천일식품(주) / 인천광역시 남동구 앵고개로 426냉동상태로 조리270g쌀(외국산), 정제수, 전란액(국산), 양파(중국산), 새우(베트남산), 양배추, 대파, 당근, 대두유, 홍피망, 부추, 소스],소스2, 소스3, 소스4, 물엿, 설탕, 향미유, 혼합제제(해바라기오일, 양파오일, 천천스모크향, 참깨오일,계피유, 아세틸프로피오닐, 아세토인), 정제소금, 소스5,복합조미식품1, 복합조미식품2, 천연향신료(후추 100%)알류(계란), 우유, 대두, 밀, 게, 새우, 돼지고기, 닭고기,쇠고기, 오징어, 조개류(굴, 홍합) 함유-18℃이하 냉동보관구입처 및 판매원별도 표기일까지-이미 냉동된바 있으니 해동 후 재냉동시키지 마시기 바랍니다.뜨거운 불로 조리시 데이지 않도록 주의하십시오.-기름으로 조리시 기름이 튀지 않도록 주의하십시오.-조리 후 제품이나 용기가 뜨거우니 주의하십시오.이 제품은 알류, 메밀, 땅콩, 고등어, 복숭아, 토마토, 아황산류 호두, 잣을 사용한제품과 같은 제조시설에서 제조하고 있습니다.
6
 
상품이 녹아서 왔어요.어떻게 해야하나요?Q&A상품이 녹아서 왔어요.날씨의 영향으로 녹아서 배송되는 경우가 많습니다.고객님께 출고전까지 냉동보관 후 기본 아이스팩 동봉하여발송하고있으나 날씨나 배송상태에 따라 녹을 수 있는점양해부탁드립니다. 상품의 신선도를 위해 아이스팩을추가적으로 구매하시는것을 적극 추천드립니다.아이스팩을 추가로 구매하고 싶어요.상품 선택후 추가구성(보냉박스)을 선택해주세요.(보냉박스 추가주문시 아이스팩 x 3팩이 추가로 포장됩니다.)추가구성 상품을 선택하세요.보냉박스 (+1,000원)보냉박스 (+1,000원)추가구성ERICE성아이스팩(납작이) x 3팩상품 주문시 기본 아이스팩은 들어가지만 하절기에는 추가 구매를 권장해드립니다.
7
 
주문전 확인사항고객센터상품에 대한 문의나 불량, 파손 문의는 고객센터 또는 게시판 이용 부탁드립니다.이용안내고객센터  010-4167-5008평 일  10시 ~ 17시점심시간  12시 ~ 13시업무로 인해 통화가 어려울 시 게시판 이용부탁드립니다.배송안내지정일 발송불가주문결제 후 3일이내 발송단, 주문량이 많거나 재고부족시 다소 기간이 소요될 수 있습니다.ㄴ 안심번호 사용은 피해주시길 바랍니다.번호가 계속바뀌어 배송에 차질이 발생합니다.▣ 제품 반품시 CJ택배사 이용바랍니다.(CJ대한통운 택배사 이용하고 있습니다.)타택배사 이용시 추가금이 발생합니다. (구매자 부담)묶음배송 가능여부 게시판 이용바랍니다.2판매자랑 협의 없는 교환·반품은 수취 거절됩니다.교환·반품판매자와 합의없이 교환 반품시 반품 불가로 상품은 다시 돌아갑니다.▣ 미배송 오배송 파손시받으신 택배박스와 운송장 사진이 필요합니다.박스와 제품을 버리신 경우 교환 환불 불가합니다.단순변심, 주문오류, 상품훼손(주소지 불분명,연락불통, 맛이없다 크기가 작다, 모양이 다르다, 행사가 취소됐다. 등)식품의 경우 재판매가 불가하여 파손, 불량에 한해 교환 환불 가능합니다.1+1상품이라도 파손된 상품만 교환 환불 가능합니다.진공포장된 상품들은 택배 배송중 진공이 풀릴수 있습니다.위 사유로 교환 반품 불가합니다. (진공풀린제품은 발송안합니다.)제품이 녹아서 도착하는 경우날씨나 수령 시간에 따라 상품이녹아서 도착할 수있습니다.녹는건 제품 하자가 아니며 녹았다는이유로 교환 환불 불가합니다.추가적인 문의를 원하시는 경우 고객센터 연락바랍니다.물품누락시상품 누락, 오배송시 연락 주시면 CCTV 확인 후 처리해드리겠습니다.택배 수령 즉시 하자여부를 확인하시고 냉동보관 바랍니다.





"""
answer = ask_gpt(user_input, ocr_data)

if not answer:  # 만약 답변이 없다면
    answer = "원하는 정보를 찾을 수 없습니다."

print(answer)